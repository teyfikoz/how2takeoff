from flask import Flask, render_template, jsonify
import sqlite3
import pandas as pd
import matplotlib.pyplot as plt
import io
import base64

app = Flask(__name__)

def get_data():
    conn = sqlite3.connect('analytics.db')
    cursor = conn.cursor()
    cursor.execute("SELECT country, city, user_agent, visit_count, time_spent FROM users")
    rows = cursor.fetchall()
    conn.close()
    
    df = pd.DataFrame(rows, columns=["country", "city", "user_agent", "visit_count", "time_spent"])
    return df

@app.route('/')
def index():
    return render_template('dashboard.html')

@app.route('/analytics')
def analytics():
    df = get_data()
    
    # User Visits by Country
    img = io.BytesIO()
    plt.figure(figsize=(10, 5))
    df['country'].value_counts().plot(kind='bar')
    plt.title('User Visits by Country')
    plt.xlabel('Country')
    plt.ylabel('Number of Visits')
    plt.xticks(rotation=45)
    plt.grid(axis='y')
    plt.savefig(img, format='png')
    img.seek(0)
    country_chart = base64.b64encode(img.getvalue()).decode()
    
    # Device Type Distribution
    df['device_type'] = df['user_agent'].apply(lambda x: 'Mobile' if 'Mobile' in x else 'Desktop')
    img = io.BytesIO()
    plt.figure(figsize=(6, 6))
    df['device_type'].value_counts().plot(kind='pie', autopct='%1.1f%%', startangle=90, colors=['lightblue', 'lightcoral'])
    plt.title('Device Type Distribution')
    plt.savefig(img, format='png')
    img.seek(0)
    device_chart = base64.b64encode(img.getvalue()).decode()
    
    # Time Spent Distribution
    img = io.BytesIO()
    plt.figure(figsize=(10, 5))
    plt.hist(df['time_spent'].dropna(), bins=20, color='orange', edgecolor='black')
    plt.title('Time Spent on Page Distribution')
    plt.xlabel('Time Spent (seconds)')
    plt.ylabel('Number of Users')
    plt.grid(axis='y')
    plt.savefig(img, format='png')
    img.seek(0)
    time_chart = base64.b64encode(img.getvalue()).decode()
    
    return jsonify({
        "country_chart": country_chart,
        "device_chart": device_chart,
        "time_chart": time_chart
    })

if __name__ == '__main__':
    app.run(debug=True)